<style>
#wrapperInfo {
	bottom: 0;
}
.list-group-item{
	cursor: pointer;
}
</style>
<div id="headerInfo" style="height: 40px;">
	<div class="row">
		<div class="col-xs-2">
			<span class="glyphicon glyphicon-chevron-left"
				onclick="history.back();" style="cursor: pointer;">&nbsp;</span>
		</div>
		<div class="col-xs-8 text-center">
			<span>个人资料</span>
		</div>
		<div class="col-xs-2"></div>
	</div>
</div>	 
<div id="wrapperInfo">
	<div id="scrollerInfo">
		<table style="width: 100%; font-size: 18px;">
			<tr>
				<td style="padding-top: 10px;" width="80%" id="photoEdt">头像</td>
				<td align="right" style="padding: 6px 14px;">
					<div class="userPhotoBig_2" itemscope
						itemtype="http://schema.org/ImageGallery">
						<figure itemprop="associatedMedia" itemscope
							itemtype="http://schema.org/ImageObject">
							<a id="userPhotoBig_a_2" itemprop="contentUrl"> <img
								id="imgHead" class="img-circle"
								style="width: 60px; height: 60px; cursor: pointer;"
								onerror="nohead(this);" itemprop="thumbnail" />
								<figcaption itemprop="caption description"></figcaption>
							</a>
						</figure>
					</div>
				</td>
			</tr>
		</table>
		
		<ul class="list-group my-list" style="margin-top:0;">
			<li class="list-group-item" onclick="pushHis({name:'forwardEdit',value:''});$('#editNickNameDiv').show();$('#edit_nickName').focus();">昵称
				<div class="pull-right">
					<input type="text" id="nickName" value="" class="selectC" readonly />
				</div>
			</li>
			<li class="list-group-item" onclick="$('#sex').mobiscroll('show')">性别
				<div class="pull-right">
					<select id="sex" class="selectC">
						<option value="1">♂</option>
						<option value="2">♀</option>
						<option value="3">保密</option>
					</select>
				</div>
			</li>
			<li class="list-group-item" onclick="$('#birthday').mobiscroll('show')">生日
				<div class="pull-right">
					<input id="birthday" type="text" class="selectC" value="" />
				</div>
			</li>
			<li class="list-group-item" onclick="$('#age').mobiscroll('show')">年龄
				<div class="pull-right">
					<input type="text" id="age" value="" class="selectC" readonly />
				</div>
			</li>
			<li class="list-group-item" onclick="$('#marry').mobiscroll('show')">情感状态
				<div class="pull-right">
					<select id="marry" class="selectC">
						<option value="1">单身</option>
						<option value="2">已婚</option>
						<option value="3">保密</option>
					</select>
				</div>
			</li>
			<li class="list-group-item"
				onclick="$('#industry').mobiscroll('show')">从事行业
				<div class="pull-right">
					<select id="industry" class="selectC">
						<option value="1">计算机/互联网/通信</option>
						<option value="2">生产/工艺/制造</option>
						<option value="3">医疗/护理/制药</option>
						<option value="4">金融/银行/投资/保险</option>
						<option value="5">商业/服务业/敷衍经营</option>
						<option value="6">文化/广告/传媒</option>
						<option value="7">娱乐/艺术/表演</option>
						<option value="8">律师/法务</option>
						<option value="9">教育/培训</option>
						<option value="10">公务员/行政/事业单位</option>
						<option value="99">其他</option>
					</select>
				</div>
			</li>
			<li class="list-group-item" onclick="$('#hobby').mobiscroll('show')">兴趣爱好
				<div class="pull-right">
					<select id="hobby" multiple class="selectC">
						<option value="1">看书</option>
						<option value="2">上网</option>
						<option value="3">听歌</option>
						<option value="11">王者荣耀</option>
					</select>
				</div>
			</li>
			<li class="list-group-item" id="resigter2_list-group-item_sign" style="min-height: 80px;" onclick="pushHis({name:'forwardEdit',value:''});$('#editSignDiv').show();$('#edit_sign').focus();$('#register2_edit_sign_span').text(120-$('#edit_sign').val().length);">个性签名
				<div class="pull-right">
					<div id="sign"></div>
				</div>
			</li>
		</ul>
	</div>
</div>

<div id="editNickNameDiv" class="editDiv ">
	<div class="row"  style="border-bottom: 1px solid #E7E4E4;height: 30px;">
		<div class="col-xs-2" >
			<span class="glyphicon glyphicon-chevron-left"
				onclick="history.back();" style="cursor: pointer;">&nbsp;</span>
		</div>
		<div class="col-xs-8 text-center" >
			<span>更改昵称</span>
		</div>
		<div class="col-xs-2">
			<span class="pull-right"><button type="button" class="btn btn-xs btn-success" id="register2_edit_nickName_btn">保存</button></span>
		</div>
	</div>
	<div class="row" style="margin-top: 20px;">
		<div class="col-xs-12">
			<input id="edit_nickName" type="text" maxlength="8"  style="border:0;border-bottom: 1px black solid;width:100%;"/>
		</div>
	</div>
</div>

<div id="editSignDiv" class="editDiv ">
	<div class="row"  style="border-bottom: 1px solid #E7E4E4;height: 30px;">
		<div class="col-xs-2" >
			<span class="glyphicon glyphicon-chevron-left"
				onclick="history.back();" style="cursor: pointer;">&nbsp;</span>
		</div>
		<div class="col-xs-8 text-center" >
			<span>更改个性签名</span>
		</div>
		<div class="col-xs-2">
			<span class="pull-right"><button type="button" class="btn btn-xs btn-success" id="register2_edit_sign_btn">保存</button></span>
		</div>
	</div>
	<div class="row" style="margin-top: 20px;">
		<div class="col-xs-12">
			<textarea id="edit_sign" style="border-bottom: 1px black solid;width: 100%;min-height: 80px;" maxlength="120" ></textarea>
			<div class="pull-right">还可输入<span id="register2_edit_sign_span"></span>个字符</div>
		</div>
	</div>
</div>
<!-- <div class="modal fade" id="myModal" tabindex="-1" role="dialog"
	aria-labelledby="myModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-body">如果不完善个人信息，系统将无法匹配您感兴趣的 [车主] / [乘客] 哦
				^_^</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-primary" data-dismiss="modal">继续完善</button>
				<button type="button" class="btn btn-default" id="btnBreak">残忍跳过
				</button>
			</div>
		</div>
	</div>
</div> -->

<script type="text/javascript">
	
	var _headPhoto;
	var jcrop_api;
	var uploader;
	var myScrollInfo;
	
	var sexInstance;
	/* window.onresize = function() {
		resizePhotoEdt();
	}
	
	function resizePhotoEdt(){
		$("#photoEdt").css({
			left : function() {
				return $("#imgHead").position().left + 55;
			}
		});
	} */
	
	var now = new Date();

	var nowDate = mini.parseDate(now,'yyyy-MM-dd');
	var nowDateStr = mini.formatDate(now,'yyyy-MM-dd');
 
	$(document).ready(function() {
		//resizePhotoEdt();
		
		var user = getCurUser();
		if(!user){
			return;
		}
			
		$("#imgHead").attr(
				"src",
				server.path + "/login/getPhoto?id=" + user.id + "&name="
						+ user.photoSmall);
		if (user.photoLarge) {
			$("#userPhotoBig_a_2").attr(
					"href",
					server.path + "/login/getPhoto?id=" + user.id + "&name="
							+ user.photoLarge);
			$("#userPhotoBig_a_2").attr(
					"data-size",
					user.photoLarge.split("_")[1] + "x"
							+ user.photoLarge.split("_")[2]);
			initPhotoSwipeFromDOM('.userPhotoBig_2');
		}
		$("#nickName").val(user.nickName);
		$("#edit_nickName").val(user.nickName);
		$("#sex").val(user.sex);
		$("#birthday").val(user.birthday);
		$("#age").val(user.age);
		$("#marry").val(user.marry);
		$("#industry").val(user.industry);
		$("#sign").html(user.sign);
		$("#edit_sign").val(user.sign);
		$("#resigter2_list-group-item_sign").css({height:'auto'});
		//兴趣爱好初始化赋值
		if(user.hobby){
			var hobbyArr = user.hobby.split(",");
			$("#hobby > option").each(function(i,o){
				$(hobbyArr).each(function(j,v){
					if(o.value == v){
						o.setAttribute("selected","selected");
					}
				});
			});
		}
		
		
		 
		
		document.addEventListener('touchmove', function(e) {
			e.preventDefault();
		}, false);
		
		myScrollInfo = new IScroll('#wrapperInfo', {
			//probeType: 2, //probeType：1对性能没有影响。在滚动事件被触发时，滚动轴是不是忙着做它的东西。probeType：2总执行滚动，除了势头，反弹过程中的事件。这类似于原生的onscroll事件。probeType：3发出的滚动事件与到的像素精度。注意，滚动被迫requestAnimationFrame（即：useTransition：假）。  
			scrollbars : true,
			mouseWheel : true,
			interactiveScrollbars : true,
			shrinkScrollbars : 'scale',
			fadeScrollbars : true,
			preventDefault : false
		});
		
		uploader = WebUploader.create({
			auto:false,
			method:'post',
			server:server.path + '/login/uploadPhoto?cookieName='+getCookieName(),
			pick:{
				id:"#photoEdt",
				label:"头像",
				multiple : false
			},
			//类型限制;
			accept:{
				title:"Images",
				extensions:"jpg,jpeg,bmp,png",
				mimeTypes:"image/*"
			},
			thumb : {
				width :  1,
				height :  1,
				// 图片质量，只有type为`image/jpeg`的时候才有效。
				quality : 100,
				// 是否允许放大，如果想要生成小图的时候不失真，此选项应该设置为false.
				allowMagnify : false,
				// 是否允许裁剪。
				crop : true,
				// 为空的话则保留原有图片格式。
				// 否则强制转换成指定的类型。
				type : "image/jpeg"
			},
			compress : false,
			//是否已二进制的流的方式发送文件，这样整个上传内容php://input都为文件内容
			sendAsBinary:false,
			//文件上传方式
			method:"POST",
			//最大上传的文件数量, 总文件大小,单个文件大小(单位字节);
			fileNumLimit : 1,
			fileSizeLimit : 1024 * 1024 * 10,
			fileSingleSizeLimit : 1024 * 1024 * 10
		});
		
		uploader.on('fileQueued', function( file ) {
			//生成预览缩略图;
			uploader.makeThumb( file, function( error, src ) {
				if (!error) {	
					$('#imgHeadPhoto').Jcrop({
						bgFade : true,
						aspectRatio : 1,
						allowSelect : false,
						allowMove : true,
						allowResize : true,
						boxWidth : $(this).width()-100,
						boxHeight : $(this).height()-100,
						handleOpacity : 0.6,
						handleSize : 9,
						minSize : [ 80,80 ]
					},function() {
						jcrop_api = this;
						jcrop_api.setImage(src,function() {
							var bounds = jcrop_api
									.getBounds();
							boundx = bounds[0];
							boundy = bounds[1];
							if(boundx<80 || boundy<80){
								alertMsg("图片尺寸过小，请选择80x80以上规格的图片！");
								jcrop_api.destroy();
								uploader.reset();
								return;
							}
							$("#headPhotoModal").modal("show");
							var x,y,x1,y1;
							if(boundx<boundy){//用宽度
								x = 0;
								y = Math.round(boundy/2-boundx/2);
								x1 = Math.round(boundx);
								y1 = Math.round(boundy/2+boundx/2);
							}else{//用高度
								x = Math.round(boundx/2-boundy/2);
								y = 0;
								x1 = Math.round(boundx/2+boundy/2);
								y1 = Math.round(boundy);
							}
							jcrop_api.setSelect([x,y,x1,y1]);
							var h = jcrop_api.getWidgetSize()[1];//图片显示高度
							$('#headPhotoModal').css({
								'margin-top' : function() {
									var top = ($(this).height()/2-h/2)-40;
									return top<0?0:top;
								}
							});
						});
					});
				}else{
					alertMsg("图片无法加载！");
				}
			});	
		
		});
		
		uploader.on('error', function( code ) {
			var text = '';
			switch( code ) {
				case  'F_DUPLICATE' : text = '该文件已经被选择了!' ;
				break;
				case  'Q_EXCEED_NUM_LIMIT' : text = '上传文件数量超过限制!' ;
				break;
				case  'F_EXCEED_SIZE' : text = '文件大小超过限制!';
				break;
				case  'Q_EXCEED_SIZE_LIMIT' : text = '所有文件总大小超过限制!';
				break;
				case 'Q_TYPE_DENIED' : text = '文件类型不正确或者是空文件!';
				break;
				default : text = '未知错误!';
					break;	
			}
			alertMsg( text );
       	}); 
		
		//上传成功后触发事件;
		uploader.on('uploadSuccess',function( file, data ){
			_headPhoto = data;
				$("#imgHead").attr("src",server.path + "/login/getPhoto?id="+user.id+"&name="+data.small);	
				$("#headPhotoModal").modal("hide");
				getCurUserForServer();
		});
		 
		$("#photoEdt>.webuploader-pick").css({
			background : 'white',
			color:"black",
			width:"100%",
			textAlign:"left"
		});

		$("#btnBreak").click(function() {
			location.href = lfwer.rootName + "/index.html";
		});

		$('#myModal').modal('hide').css({
			'margin-top' : function() {
				return ($(this).height() / 2-150);
			}
		});
		
		//隐藏模式窗口事件
		$('#uploadCarPhotoModal').on('hidden.bs.modal',
				function(e) {
					$("#imgPhoto").removeAttr("src");
				});
		$('#headPhotoModal').on('hidden.bs.modal', function(e) {
			jcrop_api.destroy();
			uploader.reset();
		});
		
		$("#register2_edit_nickName_btn").click(function(){
			var o = $("#edit_nickName");
			var v = $.trim(o.val());
			if(v == ""){
				alertMsg("昵称不能为空");
			}else if (v.length < 2){
				alertMsg("昵称最少为2个字符");
			}else{
				$.ajax({
	         		url: server.path + '/login/updateUser',
	         		data: {userId:user.id,type:'nickName',value:v},
	         		type: 'post',
	         		success:function(data){
	         			if(!data.valid){
	         				alertMsg(data.message);
	         			}else{
	         				alertMsg(data.message,"success");
	         				$("#nickName").val(v);
	         				history.back();
	         				getCurUserForServer();
	         				
	         			}
	         		},
	         		error:function(){
	         			alertMsg('保存失败！');
	         		}
	         	});
			}
		});
		
		
		$("#edit_sign").keyup(function(){
			var len = 120-$(this).val().length;
			if(len >= 0)
				$("#register2_edit_sign_span").text(len);
			else{
				
			}
				
		});
		
		$("#register2_edit_sign_btn").click(function(){
			var o = $("#edit_sign");
			var v = $.trim(o.val());
			$.ajax({
         		url: server.path + '/login/updateUser',
         		data: {userId:user.id,type:'sign',value:v},
         		type: 'post',
         		success:function(data){
         			if(!data.valid){
         				alertMsg(data.message);
         			}else{
         				alertMsg(data.message,"success");
         				$("#sign").html(v);
         				history.back();
         				getCurUserForServer();
         				
         			}
         		},
         		error:function(){
         			alertMsg('保存失败！');
         		}
         	});
			 
		});
		
		$('#sex').mobiscroll().select({
	        theme: '',     // Specify theme like: theme: 'ios' or omit setting to use default 
	        mode: 'scroller',       // Specify scroller mode like: mode: 'mixed' or omit setting to use default 
	        display: 'bottom', // Specify display mode like: display: 'bottom' or omit setting to use default 
	        lang: 'zh',        // Specify language like: lang: 'pl' or omit setting to use default 
	        headerText: function (valueText) { return "选择性别"; },
	        inputClass:'selectC', //为插件生成的input添加样式
	        onSelect: function(valueText,inst){
	        	var v;
	        	$("#sex > option").each(function(){
            		if($(this).text() == valueText){
            			v = $(this).val();
            			return false;
            		}
            	});
	         	$.ajax({
	         		url: server.path + '/login/updateUser',
	         		data: {userId:user.id,type:'sex',value:v},
	         		type: 'post',
	         		success:function(data){
	         			if(!data.valid){
	         				alertMsg(data.message);
	         			}else{
	         				alertMsg(data.message,"success");
	         				getCurUserForServer();
	         			}
	         		},
	         		error:function(){
	         			alertMsg('保存失败！');
	         		}
	         	});
	        }
		});
		
		$('#birthday').mobiscroll().date({
                  theme: '',     // Specify theme like: theme: 'ios' or omit setting to use default 
                  mode: 'scroller',       // Specify scroller mode like: mode: 'mixed' or omit setting to use default 
                  display: 'bottom', // Specify display mode like: display: 'bottom' or omit setting to use default 
                  lang: 'zh',        // Specify language like: lang: 'pl' or omit setting to use default 
                  dateFormat: 'yy-mm-dd', // 日期格式
                  showLabel:true,
                  minDate:mini.parseDate('1900-01-01'),
                  maxDate:nowDate,
                  headerText: function (valueText) { return "选择生日"; },
                  onSelect:function(valueText,inst){
                		var age = getAge(valueText);
                		valueText = valueText+","+age;
                	  	$.ajax({
         	         		url: server.path + '/login/updateUser',
         	         		data:{userId:user.id,type:'birthday',value:valueText},
         	         		type:'post',
         	         		success:function(data){
         	         			if(!data.valid){
         	         				alertMsg(data.message);
         	         			}else{
         	         				alertMsg(data.message,"success");
        	         				getCurUserForServer();
         	         			}
         	         		},
         	         		error:function(){
         	         			alertMsg('保存失败！');
         	         		}
         	         	});
                  }
		});
		
		$("#age").mobiscroll().number({
		 	theme: '',     // Specify theme like: theme: 'ios' or omit setting to use default 
            mode: 'scroller',       // Specify scroller mode like: mode: 'mixed' or omit setting to use default 
            display: 'bottom', // Specify display mode like: display: 'bottom' or omit setting to use default 
            lang: 'zh',       // Specify language like: lang: 'pl' or omit setting to use default 
            //rows:10,
            min:0,
            max:200,
            step:1,
           	onSelect: function(valueText,inst){
   	         	$.ajax({
   	         		url: server.path + '/login/updateUser',
   	         		data:{userId:user.id,type:'age',value:valueText},
   	         		type:'post',
   	         		success:function(data){
   	         			if(!data.valid){
   	         				alertMsg(data.message);
   	         			}else{
   	         				alertMsg(data.message,"success");
	         				getCurUserForServer();
   	         			}
   	         		},
   	         		error:function(){
   	         			alertMsg('保存失败！');
   	         		}
   	         	});
   	        }
		});
		
		$('#marry').mobiscroll().select({
	        theme: '',     // Specify theme like: theme: 'ios' or omit setting to use default 
	        mode: 'scroller',       // Specify scroller mode like: mode: 'mixed' or omit setting to use default 
	        display: 'bottom', // Specify display mode like: display: 'bottom' or omit setting to use default 
	        lang: 'zh',        // Specify language like: lang: 'pl' or omit setting to use default 
	        headerText: function (valueText) { return "选择情感状态"; },
	        inputClass:'selectC', //为插件生成的input添加样式
	        onSelect: function(valueText,inst){
	        	var v;
	        	$("#marry > option").each(function(){
            		if($(this).text() == valueText){
            			v = $(this).val();
            			return false;
            		}
            	});
	         	$.ajax({
	         		url: server.path + '/login/updateUser',
	         		data:{userId:user.id,type:'marry',value:v},
	         		type:'post',
	         		success:function(data){
	         			if(!data.valid){
	         				alertMsg(data.message);
	         			}else{
	         				alertMsg(data.message,"success");
	         				getCurUserForServer();
	         			}
	         		},
	         		error:function(){
	         			alertMsg('保存失败！');
	         		}
	         	});
	        }
		});
		
		$('#industry').mobiscroll().select({
            theme: '',     // Specify theme like: theme: 'ios' or omit setting to use default 
            mode: 'scroller',       // Specify scroller mode like: mode: 'mixed' or omit setting to use default 
            display: 'bottom', // Specify display mode like: display: 'bottom' or omit setting to use default 
            lang: 'zh',        // Specify language like: lang: 'pl' or omit setting to use default 
            //defaultValue:"",
            inputClass:'selectC', //为插件生成的input添加样式
            headerText: function (valueText) { return "选择从事行业"; },
            onSelect: function(valueText,inst){
            	var v;
	        	$("#industry > option").each(function(){
            		if($(this).text() == valueText){
            			v = $(this).val();
            			return false;
            		}
            	});
	         	$.ajax({
	         		url: server.path + '/login/updateUser',
	         		data:{userId:user.id,type:'industry',value:v},
	         		type:'post',
	         		success:function(data){
	         			if(!data.valid){
	         				alertMsg(data.message);
	         			}else{
	         				alertMsg(data.message,"success");
	         				getCurUserForServer();
	         			}
	         		},
	         		error:function(){
	         			alertMsg('保存失败！');
	         		}
	         	});
            }
		});
		
		$('#hobby').mobiscroll().select({
            theme: '',     // Specify theme like: theme: 'ios' or omit setting to use default 
            mode: 'scroller',       // Specify scroller mode like: mode: 'mixed' or omit setting to use default 
            display: 'bottom', // Specify display mode like: display: 'bottom' or omit setting to use default 
            lang: 'zh',        // Specify language like: lang: 'pl' or omit setting to use default 
            //defaultValue:"",
            inputClass:'selectC', //为插件生成的input添加样式
            headerText: function (valueText) { return "选择兴趣爱好"; },
            onSelect: function(valueText,inst){
            	var v = $("#hobby").val();
            	v = v.join(",");
	         	$.ajax({
	         		url: server.path + '/login/updateUser',
	         		data:{userId:user.id,type:'hobby',value:v},
	         		type:'post',
	         		success:function(data){
	         			if(!data.valid){
	         				alertMsg(data.message);
	         			}else{
	         				alertMsg(data.message,"success");
	         				getCurUserForServer();
	         			}
	         		},
	         		error:function(){
	         			alertMsg('保存失败！');
	         		}
	         	});
            }
		});
		
		$('#uploadCarPhotoModal').modal('hide').css({
			'margin-top' : function() {
				return ($(this).height()/2-180);
			}
		}); 
		
		
	});
	
	function radioValueChg(e, id) {
		$("#" + id).val(e.value);
		$("#" + id).keyup();
	}

	function savePhoto() {
		var o = jcrop_api.tellSelect();
		o.x = Math.round(o.x);
		o.y = Math.round(o.y);
		o.x2 = Math.round(o.x2);
		o.y2 = Math.round(o.y2);
		o.w = Math.round(o.w);
		o.h = Math.round(o.h);
		uploader.option('formData', o);
		uploader.upload();
	}

	function getAge(v) {
		var returnAge = 0;
		if (v != "") {
			var birthYear = parseInt(v.substring(0, 4));
			var birthMonth = parseInt(v.substring(5, 7));
			var birthDay = parseInt(v.substring(10, 12));

			var nowYear = now.getFullYear();
			var nowMonth = now.getMonth();
			var nowDay = now.getDate();

			var ageDiff = nowYear - birthYear; //年之差
			if (ageDiff > 0) {
				if (nowMonth == birthMonth) {

					var dayDiff = nowDay - birthDay;//日之差
					if (dayDiff < 0) {
						returnAge = ageDiff - 1;
					} else {
						returnAge = ageDiff;
					}
				} else {
					var monthDiff = nowMonth - birthMonth;//月之差
					if (monthDiff < 0) {
						returnAge = ageDiff - 1;
					} else {
						returnAge = ageDiff;
					}
				}

			} else {
				returnAge = 0;
			}
			if (returnAge < 0) {
				$("#birthday").val("");
				$("#age").val("");
			} else {
				$("#age").val(returnAge);
			}

		}
		return returnAge;
	}
</script>